#!/usr/bin/env sh

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
args=""

if [ $# -lt 1 ]; then
  $DIR/pretty.rb -h
  exit 1
fi

# find flags and profilenames
flags=()
profiles=()

while [[ $# -gt 0 ]]; do
  case $1 in
    -*) flags+="$1 "; shift ;;
    *) profiles+="${DIR}/../${1} "; shift ;;
  esac
done
set -- $flags

# parse flags
while getopts avh opt; do
  case $opt in
    a)
      args+="-a " ;;
    v)
      args+="-v " ;;
    h)
      args+="-h "
      echo "Usage: check_logs [OPTIONS] PROFILENAME
Options:
    -a        Show all controls (only failed controls are shown by default)
    -v        Show verbose control results
    -h        Print this message
      "
      exit 1 ;;
    \?)
      echo "Invalid argument $OPTARG"
      exit 1 ;;
  esac
done

echo "Running inspec..."
inspec exec $profiles --reporter json | $DIR/pretty.rb $args
