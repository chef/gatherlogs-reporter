#!/usr/bin/env bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
args=""

if [ $# -lt 1 ]; then
  $DIR/pretty.rb -h
  exit 1
fi

# find flags and profilenames
flags=()
profiles=()

while [[ $# -gt 0 ]]; do
  case $1 in
    -*) flags+="$1 "; shift ;;
    *) profiles+="${DIR}/../${1} "; shift ;;
  esac
done
set -- $flags

# parse flags
while getopts avph opt; do
  case $opt in
    p)
      declare -a profile_list
      profile_list=$(ls -d ${DIR}/../*/inspec.yml | awk -F / '{print $(NF-1)}')
      for p in $profile_list; do
        if [[ $p != "common" && $p != "glresources" ]]; then
          echo $p
        fi
      done
      exit 0 ;;
    a)
      args+="-a " ;;
    v)
      args+="-v " ;;
    h)
      args+="-h "
      echo "Usage: check_logs [OPTIONS] PROFILENAME
Options:
    -p        List available profiles
    -a        Show all controls (only failed controls are shown by default)
    -v        Show verbose control results
    -h        Print this message
      "
      exit 1 ;;
    \?)
      echo "Invalid argument $OPTARG"
      exit 1 ;;
  esac
done

echo "Running inspec..."
inspec exec $profiles --reporter json | $DIR/pretty.rb $args
